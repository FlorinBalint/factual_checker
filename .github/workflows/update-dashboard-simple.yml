name: Update Dashboard (Use Existing Data)

on:
  schedule:
    # Run daily at 6:00 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    paths:
      - 'dashboard/politician_stats.csv'  # Trigger when CSV is manually updated

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Check if CSV exists and is recent
      run: |
        if [ -f dashboard/politician_stats.csv ]; then
          echo "CSV file exists"
          wc -l dashboard/politician_stats.csv
          
          # Check if file is older than 7 days
          if [ "$(find dashboard/politician_stats.csv -mtime +7)" ]; then
            echo "‚ö†Ô∏è CSV file is older than 7 days"
            echo "csv_outdated=true" >> $GITHUB_ENV
          else
            echo "‚úÖ CSV file is recent"
            echo "csv_outdated=false" >> $GITHUB_ENV
          fi
        else
          echo "‚ùå CSV file does not exist"
          echo "csv_outdated=true" >> $GITHUB_ENV
        fi
        
    - name: Create issue for manual update if needed
      if: env.csv_outdated == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['data-update-needed'],
            state: 'open'
          });
          
          if (issues.length === 0) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîÑ Manual Data Update Needed',
              body: `The politician stats CSV file is outdated or missing.
              
              Please run the following locally and commit the results:
              
              \`\`\`bash
              cd app
              python main.py --output ../dashboard/politician_stats.csv --generate_party_stats false
              git add ../dashboard/politician_stats.csv
              git commit -m "Update politician stats data"
              git push
              \`\`\`
              
              This issue will be automatically closed when the CSV is updated.`,
              labels: ['data-update-needed']
            });
          }
          
    - name: Close update issues if CSV is recent
      if: env.csv_outdated == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const { data: issues } = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['data-update-needed'],
            state: 'open'
          });
          
          for (const issue of issues) {
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'closed'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: '‚úÖ Data has been updated. Closing this issue.'
            });
          }
          
    - name: Validate dashboard files
      run: |
        echo "Checking dashboard files..."
        ls -la dashboard/
        
        if [ -f dashboard/politician_stats.csv ] && [ -f dashboard/political_dashboard.html ]; then
          echo "‚úÖ All dashboard files present"
        else
          echo "‚ùå Missing dashboard files"
          exit 1
        fi